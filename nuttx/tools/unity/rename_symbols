#!/bin/bash

if [ -z "$2" ]
then
    echo Usage: $(basename $0) "<unique> <object>" 1>&2
    echo " Renames symbols generated by Unity inside object by incorporating unique string into them." 1<&2
    echo " Renaming makes it possible to have testcases with the same name and testsuite under" 1>&2
    echo " different executables" 1>&2
    echo "   unique - unique string" 1>&2
    echo "   object - object file to modify" 1>&2
    echo " Object file is transformed in-place" 1>&2
    exit 1
fi

UNIQUE=$1
OBJECT=$2
: ${OBJCOPY:=objcopy}

# Do not hate me.. love me..

$OBJCOPY --redefine-syms <(readelf -Ws $OBJECT | tail -n +4 | awk '{if ($5 != "LOCAL") {print $8, $8}}' | grep -vP '^\s+$' | sed 's/\sTEST_/ TEST_'$UNIQUE'_/') $OBJECT
